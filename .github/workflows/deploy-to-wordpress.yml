name: Publish Website

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  Publish-Website:
    name: Publish-Website
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@master

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'

    - name: Validate PHP syntax
      run: |
        echo "ğŸ” Validating PHP syntax for WordPress plugin..."
        find . -name "*.php" -exec php -l {} \;
        echo "âœ… PHP syntax validation complete"

    - name: Run plugin validation tests
      run: |
        echo "ğŸ§ª Running Secretary of DeCourse plugin validation..."
        php -r "
        \$errors = 0;

        // Check main plugin file
        if (file_exists('secretary-chatbot.php')) {
          echo 'âœ… Main plugin file exists: secretary-chatbot.php\n';
        } else {
          echo 'âŒ ERROR: Main plugin file missing: secretary-chatbot.php\n';
          \$errors++;
        }

        // Check includes directory
        if (file_exists('includes/chatbot-logic.php')) {
          echo 'âœ… Chatbot logic file exists\n';
        } else {
          echo 'âŒ ERROR: Chatbot logic file missing\n';
          \$errors++;
        }

        if (file_exists('includes/class-secretary-rest-auth.php')) {
          echo 'âœ… REST API class exists\n';
        } else {
          echo 'âŒ ERROR: REST API class missing\n';
          \$errors++;
        }

        // Check assets
        if (file_exists('assets/badger.png')) {
          echo 'âœ… Badger avatar exists\n';
        } else {
          echo 'âš ï¸  WARNING: Badger avatar missing\n';
        }

        if (file_exists('assets/chatbot.js')) {
          echo 'âœ… JavaScript file exists\n';
        } else {
          echo 'âŒ ERROR: JavaScript file missing\n';
          \$errors++;
        }

        if (file_exists('assets/style.css')) {
          echo 'âœ… CSS file exists\n';
        } else {
          echo 'âŒ ERROR: CSS file missing\n';
          \$errors++;
        }

        // Check templates
        if (file_exists('templates/floating-widget.php')) {
          echo 'âœ… Floating widget template exists\n';
        } else {
          echo 'âš ï¸  WARNING: Floating widget template missing\n';
        }

        if (\$errors > 0) {
          echo \"âŒ Validation failed with \$errors errors\n\";
          exit(1);
        } else {
          echo 'ğŸ‰ Plugin validation complete - ready for WordPress.com deployment!\n';
        }
        "

    - name: Upload the artifact
      uses: actions/upload-artifact@v4
      with:
        name: wpcom
        path: |
          .
          !.git*
          !.github/
          !README.md
          !SETUP-INSTRUCTIONS.md
          !deployment-guide.md
          !WORDPRESS-COM-SETUP.md
          !*.md
          !test-*.php
          !simple-test.php
        retention-days: 1

    - name: Deployment success notification
      run: |
        echo "ğŸš€ Secretary of DeCourse plugin packaged successfully!"
        echo "ğŸ“¦ Artifact 'wpcom' created for WordPress.com deployment"
        echo "ğŸ¯ Plugin files ready for deployment to your WordPress.com site"
        echo "ğŸ“‹ Next steps:"
        echo "   1. Connect this repository to your WordPress.com site"
        echo "   2. Deploy to /wp-content/plugins/secretary-chatbot-plugin/"
        echo "   3. Activate the plugin in WordPress admin"
        echo "   4. Test the chatbot functionality"
        echo "âœ… Deployment package ready!"
