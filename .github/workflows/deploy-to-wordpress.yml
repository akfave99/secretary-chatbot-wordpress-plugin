name: Deploy to WordPress

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        
    - name: Validate PHP syntax
      run: |
        find . -name "*.php" -exec php -l {} \;
        
    - name: Run basic tests
      run: |
        php -r "
        // Test basic plugin functionality
        if (file_exists('secretary-chatbot.php')) {
          echo 'Main plugin file exists\n';
        } else {
          echo 'ERROR: Main plugin file missing\n';
          exit(1);
        }
        
        if (file_exists('includes/chatbot-logic.php')) {
          echo 'Chatbot logic file exists\n';
        } else {
          echo 'ERROR: Chatbot logic file missing\n';
          exit(1);
        }
        
        if (file_exists('assets/badger.png')) {
          echo 'Badger avatar exists\n';
        } else {
          echo 'WARNING: Badger avatar missing\n';
        }
        
        echo 'Basic validation complete\n';
        "
        
    - name: Deploy to WordPress via FTP
      if: github.ref == 'refs/heads/main'
      uses: SamKirkland/FTP-Deploy-Action@4.3.3
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /wp-content/plugins/secretary-chatbot-plugin/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          .github/
          README.md
          
    - name: Deploy to WordPress via SFTP (Alternative)
      if: github.ref == 'refs/heads/main' && secrets.SFTP_HOST
      uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      with:
        server: ${{ secrets.SFTP_HOST }}
        username: ${{ secrets.SFTP_USERNAME }}
        password: ${{ secrets.SFTP_PASSWORD }}
        port: ${{ secrets.SFTP_PORT || 22 }}
        local_path: './*'
        remote_path: '/wp-content/plugins/secretary-chatbot-plugin/'
        
    - name: Notify deployment success
      if: success()
      run: |
        echo "✅ Deployment successful!"
        echo "Plugin deployed to WordPress site"
        echo "Check your WordPress admin to activate/test the plugin"
        
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "❌ Deployment failed!"
        echo "Check the logs above for error details"
        echo "Verify your FTP/SFTP credentials in repository secrets"
